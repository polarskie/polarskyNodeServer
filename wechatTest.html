<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>wechatTest</title>
    <link rel="stylesheet" href="css/bootstrap.css" />
    <link rel="stylesheet" href="css/wechatTest.css" />
</head>
<body>
<div class="container" id="guanzhu" hidden><div class="jumbotron"><img src="1.jpg"></div></div>

<div class="container attached" hidden><div class="jumbotron" onclick="uploadImg(event)"><h1>上传图片</h1></div></div>

<div class="container attached" hidden><div class="jumbotron" id="downloadImage"><h1>下载图片</h1></div></div>

<div class="container attached" hidden><div class="jumbotron" id="getlocation"><h1>我的位置</h1></div></div>

<div class="container attached" hidden><div class="jumbotron" id="showmeonmap"><h1>在地图上显示我</h1></div></div>

<div class="container attached" hidden><div class="jumbotron" id="saoyisao"><h1>扫一扫</h1></div></div>

<div class="container"><div class="jumbotron" id="tingting"><h1>听我说话</h1></div></div>

<div class="container attached"><div class="jumbotron" id="showattached"><h1>显示附加功能</h1></div></div>


<script src="http://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
<script src="js/jquery-1.11.3.js"></script>
<script>
    <!DATA_HERE>
</script>
<script type="text/javascript" src="js/jquery-1.11.3.js"></script>
<script type="text/javascript" src="js/bootstrap.js"></script>
<script>
    var img=new Array();
    $(document).ready(function (evnet) {
        wx.error(function(res){
            $('#guanzhu').slideDown('slow', function(){alert('请先关注我（长按二维码，选择“识别图中二维码”）,否则功能无法实现哦');});
        });
        wx.ready(function(){
            wx.onMenuShareTimeline({
                title: 'wechat API testing', // 分享标题
                link: 'http://www.polarsky.cc/jump.html', // 分享链接
                imgUrl: 'http://www.polarsky.cc/favicon.ico', // 分享图标
                success: function () {
                    alert("you have shared");
                    // 用户确认分享后执行的回调函数
                },
                cancel: function () {
                    // 用户取消分享后执行的回调函数
                },
                fail: function(msg){
                    alert(msg);
                }
            });
        });
        wx.config({
            'debug': false, // 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。
            'appId': 'wxee703ec8c8670ca9', // 必填，公众号的唯一标识
            'timestamp': timestamp, // 必填，生成签名的时间戳
            'nonceStr': nonceStr, // 必填，生成签名的随机串
            'signature': signature,// 必填，签名，见附录1
            'jsApiList': ['onMenuShareTimeline','chooseImage','previewImage','uploadImage','downloadImage', 'getLocation',
                'openLocation', 'scanQRCode', 'startRecord', 'stopRecord', 'translateVoice'] // 必填，需要使用的JS接口列表，所有JS接口列表见附录2
        });
    });
    function uploadImg(event)
    {
        wx.chooseImage({
            count: 9, // 默认9
            sizeType: ['original', 'compressed'], // 可以指定是原图还是压缩图，默认二者都有
            sourceType: ['album', 'camera'], // 可以指定来源是相册还是相机，默认二者都有
            success: function (res) {
                localIds = res.localIds; // 返回选定照片的本地ID列表，localId可以作为img标签的src属性显示图片
                function up(i) {
                    if(i>=localIds.length)
                    {
                        if(i==0)
                        {
                            alert("no picture chosen");
                        }
                        else
                        {
                            alert("all picture uploaded");
                        }
                        return;
                    }
                    wx.uploadImage({
                        localId: localIds[i], // 需要上传的图片的本地ID，由chooseImage接口获得
                        isShowProgressTips: 1, // 默认为1，显示进度提示
                        success: function (res) {
                            var serverId = res.serverId; // 返回图片的服务器端ID
                            img.push(serverId);
                            $.post("upload",
                                    serverId,
                                    function (data, status) {
                                    });
                            up(i+1);
                        }
                    });
                }
                up(0);
            }
        });
    }
    document.querySelector('#downloadImage').onclick = function () {
        function download(imgList, i) {
            if(i>=imgList.length)
            {
                if(i==0)
                {
                    alert("no img uploaded, upload some imgs first");
                }
                else
                {
                    alert("all img downloaded");
                }
                return;
            }
            wx.downloadImage({
                serverId: imgList[i],
                success: function (res) {
                    $("body").prepend("<div class='container'><img src='"+res.localId+"' ></div>");
                    download(i+1);
                }
            });
        }
        download(img, 0);
    };
    $('#getlocation').click(function()
    {
        wx.getLocation({
            type: 'wgs84', // 默认为wgs84的gps坐标，如果要返回直接给openLocation用的火星坐标，可传入'gcj02'
            success: function (res) {
                var latitude = res.latitude; // 纬度，浮点数，范围为90 ~ -90
                var longitude = res.longitude; // 经度，浮点数，范围为180 ~ -180。
                var speed = res.speed; // 速度，以米/每秒计
                var accuracy = res.accuracy; // 位置精度
                alert("your position is:\nlatitude: "+latitude+"\n longtitude: "+longitude+"\n\
                speed: "+speed+"m/s\naccuracy: "+accuracy+"m");
            }
        });
    })
    $('#showmeonmap').click(function(){
        wx.getLocation({
            type: 'wgs84', // 默认为wgs84的gps坐标，如果要返回直接给openLocation用的火星坐标，可传入'gcj02'
            success: function (res) {
                wx.openLocation({
                    latitude: res.latitude, // 纬度，浮点数，范围为90 ~ -90
                    longitude: res.longitude, // 经度，浮点数，范围为180 ~ -180。
                    name: 'me', // 位置名
                    address: 'i am here', // 地址详情说明
                    infoUrl: '' // 在查看位置界面底部显示的超链接,可点击跳转
                });
            }
        });
    })
    $('#saoyisao').click(function(){
        wx.scanQRCode({
            needResult: 1, // 默认为0，扫描结果由微信处理，1则直接返回扫描结果，
            scanType: ["qrCode","barCode"], // 可以指定扫二维码还是一维码，默认二者都有
            success: function (res) {
                alert(res.resultStr); // 当needResult 为 1 时，扫码返回的结果
            }
        });
    })
    $('#tingting').click(function(){
        wx.startRecord();
        timeRest=5;
        $('#tingting h1').html('录音还有'+timeRest+'s');
        countdown=setInterval("$('#tingting h1').html('录音还有'+(timeRest-=1)+'s')", 1000);
        setTimeout('uploadvoice()', 5000);
    });
    $('#showattached').click(function(){
        if ($('#showattached').html()=="显示附加功能")
        {
            $('#showattached').html("隐藏附加功能");
        }
        else
        {
            $('#showattached').html("显示附加功能");
        }
        $('.attached').slideToggle('slow');
    });
    function uploadvoice()
    {
        clearInterval(countdown);
        $('#tingting h1').html('听我说话');
        wx.stopRecord({
            success: function (res) {
                wx.translateVoice({
                    localId: res.localId, // 需要识别的音频的本地Id，由录音相关接口获得
                    isShowProgressTips: 1, // 默认为1，显示进度提示
                    success: function (res) {
                        alert(res.translateResult); // 语音识别的结果
                    }
                });
            }
        });
    }
    function getParameter(name)
    {
        if(location.search.indexOf(name)==-1){
            return null;
        }
        return location.search.slice(location.search.indexOf(name)+name.length+1,
                location.search.indexOf('&', location.search.indexOf(name))==-1?location.search.length:location.search.indexOf(
                        '&', location.search.indexOf(name)));
    }
</script>
</body>
</html>